{
  "version": 3,
  "sources": ["../../../../../../apps/workers/src/main.ts"],
  "sourcesContent": ["import { Logger } from '@nestjs/common';\nimport { Worker, Job } from 'bullmq';\nimport * as dotenv from 'dotenv';\nimport { parseEpub } from './epub-parser';\n\n// Load environment variables\ndotenv.config();\n\nconst logger = new Logger('Worker');\n\n// Create worker\nconst worker = new Worker(\n  'audio-processing',\n  async (job: Job) => {\n    logger.log(`Processing job ${job.id} of type ${job.name}`);\n    logger.log(`Job data:`, job.data);\n\n    switch (job.name) {\n      case 'test-job':\n        logger.log(`Test job message: ${job.data.message}`);\n        // Simulate some work\n        await new Promise((resolve) => setTimeout(resolve, 2000));\n        return { processed: true, message: job.data.message };\n\n      case 'parse-epub':\n        logger.log(\n          `Parsing EPUB: ${job.data.s3Key} for book ${job.data.bookId}`\n        );\n\n        try {\n          // TODO: Download from S3\n          // For now, we'll use mock data\n          const paragraphs = await parseEpub(job.data.s3Key);\n\n          // Save to database\n          const response = await fetch(\n            `http://localhost:3333/api/books/${job.data.bookId}/paragraphs`,\n            {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({ paragraphs }),\n            }\n          );\n\n          if (!response.ok) {\n            throw new Error(\n              `Failed to save paragraphs: ${response.statusText}`\n            );\n          }\n\n          // Update book status\n          await fetch(\n            `http://localhost:3333/api/books/${job.data.bookId}/status`,\n            {\n              method: 'PATCH',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({ status: 'READY' }),\n            }\n          );\n\n          return {\n            processed: true,\n            bookId: job.data.bookId,\n            paragraphCount: paragraphs.length,\n          };\n        } catch (error) {\n          logger.error(`Failed to parse EPUB: ${error.message}`);\n\n          // Update book status to ERROR\n          await fetch(\n            `http://localhost:3333/api/books/${job.data.bookId}/status`,\n            {\n              method: 'PATCH',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({ status: 'ERROR' }),\n            }\n          );\n\n          throw error;\n        }\n\n      default:\n        logger.warn(`Unknown job type: ${job.name}`);\n        throw new Error(`Unknown job type: ${job.name}`);\n    }\n  },\n  {\n    connection: {\n      host: process.env.REDIS_HOST || 'localhost',\n      port: parseInt(process.env.REDIS_PORT, 10) || 6379,\n    },\n    concurrency: 1,\n  }\n);\n\n// Worker event handlers\nworker.on('completed', (job) => {\n  logger.log(`Job ${job.id} completed`);\n});\n\nworker.on('failed', (job, err) => {\n  logger.error(`Job ${job?.id} failed:`, err);\n});\n\nworker.on('active', (job) => {\n  logger.log(`Job ${job.id} started`);\n});\n\nlogger.log('\uD83D\uDE80 Worker started and listening for jobs...');\n\n// Graceful shutdown\nprocess.on('SIGTERM', async () => {\n  logger.log('SIGTERM received, closing worker...');\n  await worker.close();\n  process.exit(0);\n});\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;AAAA,oBAAuB;AACvB,oBAA4B;AAC5B,aAAwB;AACxB,yBAA0B;AAG1B,OAAO,OAAO;AAEd,MAAM,SAAS,IAAI,qBAAO,QAAQ;AAGlC,MAAM,SAAS,IAAI;AAAA,EACjB;AAAA,EACA,OAAO,QAAa;AAClB,WAAO,IAAI,kBAAkB,IAAI,EAAE,YAAY,IAAI,IAAI,EAAE;AACzD,WAAO,IAAI,aAAa,IAAI,IAAI;AAEhC,YAAQ,IAAI,MAAM;AAAA,MAChB,KAAK;AACH,eAAO,IAAI,qBAAqB,IAAI,KAAK,OAAO,EAAE;AAElD,cAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,GAAI,CAAC;AACxD,eAAO,EAAE,WAAW,MAAM,SAAS,IAAI,KAAK,QAAQ;AAAA,MAEtD,KAAK;AACH,eAAO;AAAA,UACL,iBAAiB,IAAI,KAAK,KAAK,aAAa,IAAI,KAAK,MAAM;AAAA,QAC7D;AAEA,YAAI;AAGF,gBAAM,aAAa,UAAM,8BAAU,IAAI,KAAK,KAAK;AAGjD,gBAAM,WAAW,MAAM;AAAA,YACrB,mCAAmC,IAAI,KAAK,MAAM;AAAA,YAClD;AAAA,cACE,QAAQ;AAAA,cACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,cAC9C,MAAM,KAAK,UAAU,EAAE,WAAW,CAAC;AAAA,YACrC;AAAA,UACF;AAEA,cAAI,CAAC,SAAS,IAAI;AAChB,kBAAM,IAAI;AAAA,cACR,8BAA8B,SAAS,UAAU;AAAA,YACnD;AAAA,UACF;AAGA,gBAAM;AAAA,YACJ,mCAAmC,IAAI,KAAK,MAAM;AAAA,YAClD;AAAA,cACE,QAAQ;AAAA,cACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,cAC9C,MAAM,KAAK,UAAU,EAAE,QAAQ,QAAQ,CAAC;AAAA,YAC1C;AAAA,UACF;AAEA,iBAAO;AAAA,YACL,WAAW;AAAA,YACX,QAAQ,IAAI,KAAK;AAAA,YACjB,gBAAgB,WAAW;AAAA,UAC7B;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,MAAM,yBAAyB,MAAM,OAAO,EAAE;AAGrD,gBAAM;AAAA,YACJ,mCAAmC,IAAI,KAAK,MAAM;AAAA,YAClD;AAAA,cACE,QAAQ;AAAA,cACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,cAC9C,MAAM,KAAK,UAAU,EAAE,QAAQ,QAAQ,CAAC;AAAA,YAC1C;AAAA,UACF;AAEA,gBAAM;AAAA,QACR;AAAA,MAEF;AACE,eAAO,KAAK,qBAAqB,IAAI,IAAI,EAAE;AAC3C,cAAM,IAAI,MAAM,qBAAqB,IAAI,IAAI,EAAE;AAAA,IACnD;AAAA,EACF;AAAA,EACA;AAAA,IACE,YAAY;AAAA,MACV,MAAM,QAAQ,IAAI,cAAc;AAAA,MAChC,MAAM,SAAS,QAAQ,IAAI,YAAY,EAAE,KAAK;AAAA,IAChD;AAAA,IACA,aAAa;AAAA,EACf;AACF;AAGA,OAAO,GAAG,aAAa,CAAC,QAAQ;AAC9B,SAAO,IAAI,OAAO,IAAI,EAAE,YAAY;AACtC,CAAC;AAED,OAAO,GAAG,UAAU,CAAC,KAAK,QAAQ;AAChC,SAAO,MAAM,OAAO,KAAK,EAAE,YAAY,GAAG;AAC5C,CAAC;AAED,OAAO,GAAG,UAAU,CAAC,QAAQ;AAC3B,SAAO,IAAI,OAAO,IAAI,EAAE,UAAU;AACpC,CAAC;AAED,OAAO,IAAI,oDAA6C;AAGxD,QAAQ,GAAG,WAAW,YAAY;AAChC,SAAO,IAAI,qCAAqC;AAChD,QAAM,OAAO,MAAM;AACnB,UAAQ,KAAK,CAAC;AAChB,CAAC;",
  "names": []
}
