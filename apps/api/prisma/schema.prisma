generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Book {
  id              String            @id @default(uuid())
  title           String
  author          String?
  language        String            @default("he")
  uploadedAt      DateTime          @default(now())
  s3Key           String            @unique // S3 key for the original EPUB
  status          BookStatus        @default(PROCESSING)
  chapterTitles   String[]          @default([]) // User-provided chapter titles
  paragraphs      Paragraph[]
  textCorrections TextCorrection[]  // All text corrections for this book
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@map("books")
}

model Paragraph {
  id            String      @id @default(uuid())
  bookId        String
  book          Book        @relation(fields: [bookId], references: [id], onDelete: Cascade)
  chapterNumber Int
  orderIndex    Int         // Order within the book
  content       String      @db.Text
  audioS3Key    String?     // S3 key for generated audio
  audioStatus   AudioStatus @default(PENDING)
  audioDuration Float?      // Duration in seconds
  textCorrections TextCorrection[]   // Track all text corrections for this paragraph
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([bookId, orderIndex])
  @@index([bookId])
  @@map("paragraphs")
}

model TextCorrection {
  id              String    @id @default(uuid())
  paragraphId     String
  paragraph       Paragraph @relation(fields: [paragraphId], references: [id], onDelete: Cascade)
  bookId          String    // Direct reference to book for easier querying
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  originalWord    String    // The specific word that was changed (e.g., "שלום")
  correctedWord   String    // What the word was changed to (e.g., "שָׁלוֹם")
  sentenceContext String    @db.Text // The full sentence context for better matching
  fixType         String?   // Optional categorization like 'niqqud', 'pronunciation', etc.
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([paragraphId])
  @@index([bookId])
  @@index([originalWord])
  @@index([correctedWord])
  @@index([originalWord, correctedWord])
  @@map("text_corrections")
}

enum BookStatus {
  UPLOADING
  PROCESSING
  READY
  ERROR
}

enum AudioStatus {
  PENDING
  GENERATING
  READY
  ERROR
}